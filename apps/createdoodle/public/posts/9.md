# Turborepo를 이용하여 모노레포 구성하기

## 모노레포란

모노레포 (monorepo)는 여러 프로젝트나 패키지를 하나의 Repository 안에서 관리하는 방식이다.  
같은 저장소 안에 다양한 프로젝트가 함께 존재하면서 코드와 의존성을 공유할 수 있는 구조라 협업이나 배포 효율성을 높이는 데 유리하다.  
회사나 개인 프로젝트를 진행할 때 프로젝트를 여러개 진행하면서 중복되거나 공통으로 빼면 좋은 코드들을 반복적으로 많이 작성했었는데 만약 모노레포로 진행하게 된다면 그런 코드들을 패키지화하여 관리하는게 수월해진다.

## Turborepo란

https://turbo.build/

Turborepo는 JavaScript/TypeScript을 대상으로한 고성능 빌드 시스템이다.  
보통의 모노레포는 스크립트를 실행하려면 아주 많은 작업을 진행해야하며 이에 따라 속도 저하가 발생한다. 그러나 터보레포는 이러한 작업들을 병렬적으로 진행하여 빠른 속도로 작업을 완료할 수 있다.  
또한 빌드 시 캐싱을 하여 작업을 한 번만 실행하도록 하고, 이로 인해 빌드 속도가 빨라진다. Remote caching을 이용하여 팀 또는 CI에서 터보레포의 캐시를 공유할 수도 있다.

## 패키지 관리자로 pnpm을 사용하는 이유

터보레포는 npm, yarn, pnpm 등 여러 패키지 관리자를 사용할 수 있는데, 그중에서 나는 모노레포에 적합하다는 pnpm을 사용하려고 한다.  
pnpm이 모노레포에서 유용한 이유는 다음과 같다.

1. 패키지 설치 시 패키지 전역 저장 및 하드 링크로 인한 참조로 디스크 공간을 크게 절약할 수 있다.
2. 의존성을 각 프로젝트마다 격리된 환경에서 관리함으로써 서로 다른 프로젝트 간의 의존성 충돌을 감소시킨다.
3. `pnpm workspaces` 기능을 통한 쉬운 패키지 관리가 가능하다.
4. 의존성 설치 속도가 빠르고 효율적이다.
5. 엄격한 의존성 관리로 디버깅이 용이하다.

- `package.json`에 명시된 의존성만 실제로 설치 및 사용하고 의도하지 않는 전역 의존성에 대한 접근을 방지한다.

6. 버추얼 스코어로 프로젝트 내에서 필요한 패키지를 효율적으로 캐싱하고, 프로젝트 간에 중복 없이 패키지를 공유할 수 있다.
7. 여러 패키지의 스크립트를 병렬로 실행할 수 있다.

## Turborepo 시작하기

모노레포에 대해 많은 지식을 가지고 있지 않아 우선 터보레포가 제공하는 템플릿을 설치하여 사용해보기로 하였다.

```
pnpm dlx create-turbo@latest
```

설치가 끝나면 해당 폴더 구조를 확인할 수 있다.

![turborepo-folder](photo/9/turborepo-folder.png)

- apps : 프로젝트들을 넣는 폴더
- packages : 내부에서 사용할 패키지를 넣는 폴더

### 내부 패키지 사용하기

내부 패키지를 사용하려면 package.json의 dependencies에 해당 코드를 추가하면 된다.
추가한 후에는 `pnpm install` 을 해줘야 적용이 완료된다.

```json
{
  ...
  "devDependencies": {
    // 패키지명 : "workspace:*"
    "@yeong/typescript-config": "workspace:*",
    "@yeong/eslint-config": "workspace:*",
    ...
  }
  ...
}
```

## 내부 패키지 만들기

https://turbo.build/repo/docs/crafting-your-repository/creating-an-internal-package

프로젝트를 할 때마다 util을 모아둔 코드들을 많이 사용하는데 이걸 이용하여 utils 패키지를 만들어보기로 하였다.

### 1. packages 폴더에 utils 폴더 만들기

### 2. package.json 파일 생성하기

```json
{
  // 패키지명 설정
  "name": "@yeong/utils",
  "type": "module",
  "scripts": {
    "dev": "tsc --watch",
    "build": "tsc"
  },
  "devDependencies": {
    "@yeong/typescript-config": "workspace:*",
    "@yeong/eslint-config": "workspace:*",
    "typescript": "latest"
  }
}
```

### 3. 코드 작성하기

```ts
// src/string/string.utils.ts
export const parseDomSizeValue = (value: string | number, unit = 'px') => {
  if (typeof value === 'string') return value;
  return `${value}${unit}`;
};
```

### 4. 파일 내보내기

패키지명에 exports 속성을 넣어 import 할 수 있도록 설정해준다.

```json
// package.json
{
  // 패키지명 설정
  "name": "@yeong/utils",
  ...
  "exports": {
    "./string": {
      "types": "./src/string/string.utils.ts",
      "default": "./dist/string/string.utils.js"
    }
  },
  ...
}
```

- `"./string"` : import시 패키지명 뒤에 붙을 경로를 설정해준다. (예: `"@yeong/utils/string"`)
  - `"."` 으로 설정하면 `"@yeong/utils"` 로 불러와진다.
- `"types"` : 타입 추론 시 참조할 파일을 설정해준다. 아까 작성한 코드 파일의 경로를 입력하면 된다.

## UI 패키지 만들기
